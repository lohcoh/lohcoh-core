@using LowKode.Core.Configuration
@using LowKode.Core.Metadata
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Rendering
@using System
@namespace LowKode.Core.Components

<Scope OnInit="BindModel" Context="FormSite">
    @foreach (var property in modelMetadata.Properties)
    {
        <Scope OnInit="site => BindProperty(site, property)">
            @ChildContent
        </Scope>
    }
</Scope>


@code
{
    /// <summary>
    /// Renders the properties of a form model.
    /// Can only be used with an <EditForm/> component.
    /// </summary>

        /// <summary>
        /// The template for rendering properties
        /// </summary>
        [Parameter]
        public RenderFragment ChildContent { get; set; }

        [CascadingParameter]
        EditContext EditContext { get; set; }

        TypeDescriptor modelMetadata;
        Type modelType;
        
        protected override void OnInitialized()
        {
            base.OnInitialized();

            if (EditContext == null)
            {
                throw new InvalidOperationException("No EditContext found");
            }

            modelType = EditContext.Model.GetType();
        }
        void BindProperty(IComponentSite site, PropertyDescriptor property)
        {
            site.Context.ComponentSiteSpecification.ModelMember = property.ToMemberPath();
        }
        void BindModel(IComponentSite site)
        {
            // add the model and it's type to the current context before rendering properties
            modelMetadata = site.Metadata.ForSystemType(modelType);
            site.Context.ComponentSiteSpecification.Model = EditContext.Model;
            site.Context.ComponentSiteSpecification.ModelType = modelMetadata;
        }

}
